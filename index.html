<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SuMe-Chat | Secure P2P Chat</title>
  <style>
    /* ---------------- Body ---------------- */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #eee;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 { color: #28a745; margin-top: 20px; }

    /* ---------------- Chat Box ---------------- */
    #chatContainer {
      width: 90%;
      max-width: 500px;
      background: #1e1e1e;
      border-radius: 12px;
      border: 1px solid #444;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      margin: 20px 0;
    }
    #chat {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* ---------------- Chat Bubbles ---------------- */
    .message {
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
      position: relative;
    }
    .me {
      background-color: #007bff;
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .friend {
      background-color: #2c2c2c;
      color: #eee;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    .timestamp {
      font-size: 10px;
      color: #aaa;
      margin-top: 2px;
      text-align: right;
    }

    /* ---------------- Input & Buttons ---------------- */
    #controls {
      display: flex;
      border-top: 1px solid #444;
      padding: 5px;
      background-color: #1a1a1a;
    }
    #msgInput {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 14px;
      margin-right: 5px;
      background-color: #2a2a2a;
      color: #fff;
    }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #sendBtn { background-color: #28a745; color: #fff; }
    #sendBtn:hover:enabled { background-color: #1e7e34; }
    #copyBtn { background-color: #007bff; color: #fff; margin-left: 10px; }
    #copyBtn:hover { background-color: #0056b3; }

    /* ---------------- Peer ID & Status ---------------- */
    #myId, #status {
      margin: 5px 0;
      font-size: 14px;
    }
    #status.connecting { color: orange; }
    #status.connected { color: #00ff00; }
    #status.disconnected { color: red; }
  </style>
</head>
<body>
  <h2>üîê SuMe-Chat</h2>

  <!-- Peer ID & Copy -->
  <p id="myId">Your Peer ID: <span id="myPeerId">Generating...</span>
    <button id="copyBtn" onclick="copyPeerId()">üìã Copy</button>
  </p>

  <!-- Friend ID Input -->
  <input id="peerIdInput" placeholder="Friend's Peer ID" style="width:90%;max-width:500px;padding:8px;border-radius:8px;border:none;margin-bottom:5px;background:#2a2a2a;color:#fff;" />
  <button onclick="connectPeer()">Connect</button>

  <!-- Status -->
  <p id="status" class="disconnected">Status: Not connected</p>

  <!-- Chat Container -->
  <div id="chatContainer">
    <div id="chat"></div>
    <div id="controls">
      <input id="msgInput" placeholder="Type a message..." disabled />
      <button id="sendBtn" onclick="sendMsg()" disabled>Send</button>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs/dist/peerjs.min.js"></script>
  <script>
    // ---------------- PeerJS Setup ----------------
    const peer = new Peer({
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'turn:turn.anyfirewall.com:443?transport=tcp', username: 'webrtc', credential: 'webrtc' }
        ]
      }
    });

    let conn;
    let cryptoKey;

    // ---------------- Encryption ----------------
    async function generateKey() {
      cryptoKey = await crypto.subtle.generateKey(
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt", "decrypt"]
      );
    }

    async function exportKey() {
      const raw = await crypto.subtle.exportKey("raw", cryptoKey);
      return btoa(String.fromCharCode(...new Uint8Array(raw)));
    }

    async function importKey(base64) {
      const raw = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
      cryptoKey = await crypto.subtle.importKey("raw", raw, "AES-GCM", true, ["encrypt", "decrypt"]);
    }

    async function encryptMsg(message) {
      const enc = new TextEncoder().encode(message);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ciphertext = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, enc);
      return { iv: Array.from(iv), data: Array.from(new Uint8Array(ciphertext)) };
    }

    async function decryptMsg(payload) {
      const iv = new Uint8Array(payload.iv);
      const data = new Uint8Array(payload.data);
      const plaintext = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, data);
      return new TextDecoder().decode(plaintext);
    }

    // ---------------- Peer ID ----------------
    peer.on('open', id => {
      document.getElementById("myPeerId").innerText = id;
      generateKey();
    });

    function copyPeerId() {
      const peerText = document.getElementById("myPeerId").innerText;
      if (!peerText) return alert("Peer ID not generated yet!");
      navigator.clipboard.writeText(peerText)
        .then(() => alert("Peer ID copied!"))
        .catch(() => alert("Failed to copy!"));
    }

    // ---------------- Connection ----------------
    function connectPeer() {
      const peerId = document.getElementById("peerIdInput").value.trim();
      if (!peerId) return alert("Enter a Peer ID first!");
      setStatus("Connecting...", "connecting");

      conn = peer.connect(peerId);

      conn.on('open', async () => {
        setStatus("Connected to " + peerId, "connected");
        addMsg("‚úÖ Connected to " + peerId, "system");
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("msgInput").disabled = false;
        conn.send({ key: await exportKey() });
      });

      conn.on('data', handleData);

      conn.on('close', () => {
        setStatus("Disconnected", "disconnected");
        addMsg("‚ùå Connection closed", "system");
        document.getElementById("sendBtn").disabled = true;
        document.getElementById("msgInput").disabled = true;
      });

      conn.on('error', () => {
        setStatus("Error / Retry", "disconnected");
        addMsg("‚ö† Connection error. Try again.", "system");
      });
    }

    async function handleData(data) {
      if (data.key) {
        await importKey(data.key);
        addMsg("üîê Secure channel established!", "system");
      } else if (data.msg) {
        const text = await decryptMsg(data.msg);
        addMsg(text, "friend");
      }
    }

    async function sendMsg() {
      const msg = document.getElementById("msgInput").value.trim();
      if (conn && msg) {
        const encrypted = await encryptMsg(msg);
        conn.send({ msg: encrypted });
        addMsg(msg, "me");
        document.getElementById("msgInput").value = "";
      }
    }

    peer.on('connection', c => {
      conn = c;
      conn.on('data', handleData);
      setStatus("Connected to " + conn.peer, "connected");
      addMsg("üîî Someone connected to you!", "system");
      document.getElementById("sendBtn").disabled = false;
      document.getElementById("msgInput").disabled = false;
    });

    // ---------------- Chat & Status Helpers ----------------
    function addMsg(text, type) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      if(type === "me") div.className = "message me";
      else if(type === "friend") div.className = "message friend";
      else div.className = "message system";
      div.innerHTML = text + `<div class="timestamp">${new Date().toLocaleTimeString()}</div>`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function setStatus(text, cls) {
      const status = document.getElementById("status");
      status.innerText = "Status: " + text;
      status.className = cls;
    }
  </script>
</body>
</html>
