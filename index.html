<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SuMe-Chat | Secure P2P Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ---------------------------- FULL ORIGINAL CSS ---------------------------- */
* { box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #1b1b1b;
  color: #eee;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding: 20px 10px;
}
#chatCard {
  width: 100%;
  max-width: 700px;
  background: #262626;
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  padding: 25px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}
h2 {
  color: #28a745;
  text-align: center;
  margin: 0 0 15px 0;
  font-weight: 600;
  font-size: 1.8rem;
}
#myId {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #2e2e2e;
  padding: 12px 15px;
  border-radius: 15px;
  font-size: 1rem;
  flex-wrap: wrap;
}
#copyBtn {
  padding: 6px 12px;
  border: none;
  border-radius: 12px;
  background: #28a745;
  color: white;
  cursor: pointer;
  font-size: 0.85rem;
  margin-top: 5px;
}
#copyBtn:hover { background: #1e7e34; }
.connect-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.connect-row input {
  flex: 1 1 250px;
  padding: 12px;
  border-radius: 15px;
  border: none;
  background: #2e2e2e;
  color: #fff;
  font-size: 0.95rem;
}
.connect-row button {
  padding: 12px 18px;
  border-radius: 15px;
  border: none;
  background: #28a745;
  color: white;
  cursor: pointer;
  font-size: 0.95rem;
}
.connect-row button:hover { background: #1e7e34; }
#status {
  text-align: center;
  font-size: 0.9rem;
  padding: 6px;
  border-radius: 12px;
  word-break: break-word;
}
#status.connecting { color: orange; }
#status.connected { color: #00ff00; }
#status.disconnected { color: red; }
#chatContainer {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 550px;
  background: #1e1e1e;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.4);
}
#chat {
  flex: 1;
  padding: 18px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
  scroll-behavior: smooth;
}
.message {
  padding: 10px 18px;
  border-radius: 20px;
  max-width: 75%;
  word-wrap: break-word;
  font-size: 0.95rem;
  position: relative;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.me { background-color: #28a745; color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
.friend { background-color: #2e2e2e; color: #fff; align-self: flex-start; border-bottom-left-radius: 5px; }
.system { background-color: #444; color: #ffcc00; align-self: center; max-width: 90%; text-align: center; font-weight: bold; }
.timestamp { font-size: 0.75rem; color: #aaa; margin-top: 2px; text-align: right; }
.receipt { font-size: 0.75rem; color: #0f0; margin-left: 5px; }
#controls {
  flex-shrink: 0;
  display: flex;
  gap: 12px;
  padding: 12px;
  background: #2e2e2e;
  border-top: 1px solid #333;
  border-radius: 0 0 15px 15px;
}
#msgInput {
  flex: 1 1 200px;
  padding: 12px;
  border-radius: 15px;
  border: none;
  outline: none;
  font-size: 0.95rem;
  background: #1e1e1e;
  color: #fff;
}
#sendBtn {
  padding: 12px 18px;
  border-radius: 15px;
  border: none;
  background: #28a745;
  color: white;
  cursor: pointer;
  font-size: 0.95rem;
}
#sendBtn:disabled { opacity: 0.5; cursor: not-allowed; }
#sendBtn:hover:enabled { background: #1e7e34; }
#footer {
  text-align: center;
  font-weight: bold;
  color: #ffcc00;
  margin-top: 12px;
  text-shadow: 0 0 5px #ffcc00;
  font-size: 1rem;
}
@media(max-width: 480px){
  #chatCard { padding: 15px; }
  h2 { font-size: 1.4rem; }
  .connect-row input, #msgInput { font-size: 0.85rem; padding: 10px; }
  .connect-row button, #sendBtn, #copyBtn { font-size: 0.8rem; padding: 8px 12px; }
  .message { font-size: 0.85rem; }
  #status { font-size: 0.8rem; }
  #footer { font-size: 0.85rem; }
  #chatContainer { height: 80vh; }
}
</style>
</head>
<body>
<div id="chatCard">
  <h2>üîê SuMe-Chat</h2>

  <div id="myId">
    <span>Your Peer ID: <span id="myPeerId">Generating...</span></span>
    <button id="copyBtn" onclick="copyPeerId()">üìã Copy</button>
  </div>

  <div class="connect-row">
    <input id="peerIdInput" placeholder="Friend's Peer ID" />
    <button onclick="connectPeer()">Connect</button>
  </div>

  <div id="status" class="disconnected">Status: Not connected</div>

  <div id="chatContainer">
    <div id="chat"></div>
    <div id="controls">
      <input id="msgInput" placeholder="Type a message..." disabled />
      <button id="sendBtn" onclick="sendMsg()" disabled>Send</button>
    </div>
  </div>

  <div id="footer">Created by Suhail Al Mehedi</div>
</div>

<script src="https://unpkg.com/peerjs/dist/peerjs.min.js"></script>
<script>
let conn, cryptoKey, reconnectAttempts=0, maxReconnect=5, messageQueue=[];
let isTyping=false, typingTimeout;

// ------------------ PEERJS ------------------
const peer = new Peer({host:'0.peerjs.com',port:443,secure:true,path:'/',debug:1,config:{
  iceServers:[
    { urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'] },
    { urls:'turn:relay1.expressturn.com:3478', username:'efYQXKAB2wxWtdjKOf', credential:'W9qTXeDtvz7cOZZv' }
  ],
  sdpSemantics:'unified-plan'
}});

peer.on('open', async id=>{
  document.getElementById('myPeerId').innerText=id;
  await generateKey();
  setStatus('Ready to connect','disconnected');
  flushQueue();
});

peer.on('error', err=>{ console.error(err); addMsg('‚ö† '+err.message,'system'); setStatus('Error','disconnected'); });

// ------------------ CRYPTO ------------------
async function generateKey(){ cryptoKey=await crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt","decrypt"]); }
async function exportKey(){ const raw=await crypto.subtle.exportKey("raw",cryptoKey); return btoa(String.fromCharCode(...new Uint8Array(raw))); }
async function importKey(base64){ try{ const raw=Uint8Array.from(atob(base64),c=>c.charCodeAt(0)); cryptoKey=await crypto.subtle.importKey("raw",raw,"AES-GCM",true,["encrypt","decrypt"]); } catch(e){ addMsg("‚ùå Key exchange failed!","system"); } }
async function encryptMsg(msg){ const enc=new TextEncoder().encode(msg); const iv=crypto.getRandomValues(new Uint8Array(12)); const ciphertext=await crypto.subtle.encrypt({name:"AES-GCM",iv},cryptoKey,enc); return {iv:Array.from(iv),data:Array.from(new Uint8Array(ciphertext))}; }
async function decryptMsg(payload){ try{ const iv=new Uint8Array(payload.iv); const data=new Uint8Array(payload.data); return new TextDecoder().decode(await crypto.subtle.decrypt({name:"AES-GCM",iv},cryptoKey,data)); } catch{ addMsg("‚ö† Decryption failed.","system"); return null; } }

// ------------------ UTILITIES ------------------
function sanitize(str){ return str.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function copyPeerId(){ const id=document.getElementById('myPeerId').innerText; if(id && id!=='Generating...') navigator.clipboard.writeText(id).then(()=>alert('Peer ID copied!')); }
function setStatus(text,cls){ const s=document.getElementById('status'); s.innerText="Status: "+text; s.className=cls; }
function addMsg(text,type){ const chat=document.getElementById('chat'); const div=document.createElement('div'); div.className=type==='me'?'message me':type==='friend'?'message friend':'message system'; div.innerHTML=sanitize(text)+`<div class="timestamp">${new Date().toLocaleTimeString()}</div>`; chat.appendChild(div); chat.scrollTo({top:chat.scrollHeight,behavior:'smooth'}); }
function addMsgWithReceipt(text,type,msgId,status){ const chat=document.getElementById('chat'); const div=document.createElement('div'); div.className=type==='me'?'message me':type==='friend'?'message friend':'message system'; div.id=msgId?`msg-${msgId}`:''; div.innerHTML=sanitize(text)+(type==='me'&&status?` <span class="receipt">${status==='pending'?'‚è≥':status==='sent'?'‚úÖ':'‚ùå'}</span>`:'')+`<div class="timestamp">${new Date().toLocaleTimeString()}</div>`; chat.appendChild(div); chat.scrollTo({top:chat.scrollHeight,behavior:'smooth'}); }
function updateMsgStatus(msgId,status){ const div=document.getElementById(`msg-${msgId}`); if(div){ const receipt=div.querySelector('.receipt'); if(receipt) receipt.innerText=status==='sent'?'‚úÖ':status==='delivered'?'‚úÖ‚úÖ':'‚ùå'; } }

// ------------------ CHAT ------------------
function enableChat(enabled){ document.getElementById('sendBtn').disabled=!enabled; document.getElementById('msgInput').disabled=!enabled; }
function flushQueue(){ if(conn && conn.open && messageQueue.length){ messageQueue.forEach(async m=>{ const encrypted=await encryptMsg(m.msg); conn.send({msg:encrypted,msgId:m.msgId}); addMsgWithReceipt(m.msg,'me',m.msgId,'sent'); }); messageQueue=[]; } }

// ------------------ CONNECTION ------------------
function connectPeer(){
  const peerId=document.getElementById('peerIdInput').value.trim();
  if(!peerId) return alert('Enter Peer ID!');
  if(peerId===peer.id) return alert('Cannot connect to yourself!');
  setStatus('Connecting...','connecting');
  conn=peer.connect(peerId,{reliable:true});
  setupConnectionEvents(conn);
}

function setupConnectionEvents(c){
  c.on('open',async()=>{
    reconnectAttempts=0;
    setStatus('Connected to '+c.peer,'connected');
    addMsg('‚úÖ Connected to '+c.peer,'system');
    enableChat(true);
    try{ c.send({key:await exportKey()}); } catch(e){ addMsg('‚ö† Could not send key.','system'); }
    flushQueue();
  });
  c.on('data',handleData);
  c.on('close',()=>{ addMsg('‚ùå Connection closed','system'); enableChat(false); autoReconnect(); });
  c.on('error',err=>{ console.error(err); addMsg('‚ö† Connection error','system'); enableChat(false); autoReconnect(); });
}

// ------------------ AUTO-RECONNECT ------------------
function autoReconnect(){ if(reconnectAttempts>=maxReconnect){ setStatus('Disconnected','disconnected'); return; } reconnectAttempts++; setStatus(`Reconnecting... (attempt ${reconnectAttempts})`,'connecting'); setTimeout(()=>{ if(conn) conn.close(); connectPeer(); },Math.min(5000*reconnectAttempts,30000)); }

// ------------------ MESSAGES ------------------
async function sendMsg(){
  const msgInput=document.getElementById('msgInput');
  const msg=msgInput.value.trim();
  if(!msg) return;
  const msgId=Date.now()+Math.random();
  addMsgWithReceipt(msg,'me',msgId,'pending');

  if(conn && conn.open){
    try{ const encrypted=await encryptMsg(msg); conn.send({msg:encrypted,msgId}); updateMsgStatus(msgId,'sent'); } 
    catch(e){ updateMsgStatus(msgId,'failed'); addMsg('‚ö† Failed to send.','system'); }
  } else { messageQueue.push({msg,msgId}); }
  msgInput.value='';
}

// ------------------ TYPING INDICATOR ------------------
const typingDiv=document.createElement('div'); typingDiv.className='message system'; typingDiv.id='typingIndicator'; typingDiv.style.display='none'; typingDiv.innerText='Friend is typing...'; document.getElementById('chat').appendChild(typingDiv);
document.getElementById('msgInput').addEventListener('input',()=>{
  if(conn && conn.open){
    if(!isTyping){ isTyping=true; conn.send({typing:true}); }
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>{ isTyping=false; conn.send({typing:false}); },1000);
  }
});

// ------------------ DATA HANDLING ------------------
async function handleData(data){
  if(data.key){ await importKey(data.key); addMsg('üîê Secure channel established!','system'); }
  else if(data.msg){ const text=await decryptMsg(data.msg); if(text) addMsgWithReceipt(text,'friend',data.msgId,'delivered'); if(data.msgId) conn.send({delivered:data.msgId}); }
  else if(data.typing!==undefined){ typingDiv.style.display=data.typing?'block':'none'; }
  else if(data.delivered) updateMsgStatus(data.delivered,'delivered');
}

// ------------------ INCOMING CONNECTION ------------------
peer.on('connection',c=>{
  if(conn && conn.open){ c.close(); return; }
  conn=c;
  setupConnectionEvents(conn);
  setStatus('Connected to '+conn.peer,'connected');
  addMsg('üîî Someone connected to you!','system');
  enableChat(true);
});
</script>
</body>
</html>
