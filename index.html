<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SuMe-Chat | Secure P2P Chat</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #1b1b1b;
  color: #eee;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding-top: 30px;
}

#chatCard {
  width: 90%;
  max-width: 500px;
  background: #262626;
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

h2 {
  color: #28a745;
  text-align: center;
  margin: 0 0 10px 0;
  font-weight: 600;
}

#myId {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #2e2e2e;
  padding: 10px 15px;
  border-radius: 15px;
  font-size: 14px;
}
#copyBtn {
  padding: 5px 10px;
  border: none;
  border-radius: 12px;
  background: #28a745;
  color: white;
  cursor: pointer;
  font-size: 12px;
}
#copyBtn:hover { background: #1e7e34; }

.connect-row {
  display: flex;
  gap: 10px;
}
.connect-row input {
  flex: 1;
  padding: 10px;
  border-radius: 15px;
  border: none;
  background: #2e2e2e;
  color: #fff;
  font-size: 14px;
}
.connect-row button {
  padding: 10px 15px;
  border-radius: 15px;
  border: none;
  background: #28a745;
  color: white;
  cursor: pointer;
  font-size: 14px;
}
.connect-row button:hover { background: #1e7e34; }

#status {
  text-align: center;
  font-size: 13px;
  padding: 5px;
  border-radius: 12px;
}
#status.connecting { color: orange; }
#status.connected { color: #00ff00; }
#status.disconnected { color: red; }

#chatContainer {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 400px;
  background: #1e1e1e;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.4);
}
#chat {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message {
  padding: 10px 15px;
  border-radius: 20px;
  max-width: 75%;
  word-wrap: break-word;
  font-size: 14px;
  position: relative;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.me { background-color: #28a745; color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
.friend { background-color: #2e2e2e; color: #fff; align-self: flex-start; border-bottom-left-radius: 5px; }
.system { background-color: #444; color: #ffcc00; align-self: center; max-width: 90%; text-align: center; font-weight: bold; }
.timestamp { font-size: 10px; color: #aaa; margin-top: 2px; text-align: right; }

#controls {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #2e2e2e;
  border-radius: 15px;
}
#msgInput {
  flex: 1;
  padding: 10px;
  border-radius: 15px;
  border: none;
  outline: none;
  font-size: 14px;
  background: #1e1e1e;
  color: #fff;
}
#sendBtn {
  padding: 10px 15px;
  border-radius: 15px;
  border: none;
  background: #28a745;
  color: white;
  cursor: pointer;
  font-size: 14px;
}
#sendBtn:disabled { opacity: 0.5; cursor: not-allowed; }
#sendBtn:hover:enabled { background: #1e7e34; }

#footer {
  text-align: center;
  font-weight: bold;
  color: #ffcc00;
  margin-top: 10px;
  text-shadow: 0 0 5px #ffcc00;
}
</style>
</head>
<body>
<div id="chatCard">
<h2>üîê SuMe-Chat</h2>

<div id="myId">
  <span>Your Peer ID: <span id="myPeerId">Generating...</span></span>
  <button id="copyBtn" onclick="copyPeerId()">üìã Copy</button>
</div>

<div class="connect-row">
  <input id="peerIdInput" placeholder="Friend's Peer ID" />
  <button onclick="connectPeer()">Connect</button>
</div>

<div id="status" class="disconnected">Status: Not connected</div>

<div id="chatContainer">
  <div id="chat"></div>
  <div id="controls">
    <input id="msgInput" placeholder="Type a message..." disabled />
    <button id="sendBtn" onclick="sendMsg()" disabled>Send</button>
  </div>
</div>

<div id="footer">Created by Suhail Al Mehedi</div>
</div>

<script src="https://unpkg.com/peerjs/dist/peerjs.min.js"></script>
<script>
let conn;
let cryptoKey;

// Fast PeerJS server
const peer = new Peer({
  host: '0.peerjs.com',
  port: 443,
  secure: true,
  path: '/'
});

peer.on('open', async id => {
  document.getElementById('myPeerId').innerText = id;
  await generateKey();
});

// --- Encryption functions ---
async function generateKey(){ cryptoKey = await crypto.subtle.generateKey({name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]); }
async function exportKey(){ const raw = await crypto.subtle.exportKey("raw", cryptoKey); return btoa(String.fromCharCode(...new Uint8Array(raw))); }
async function importKey(base64){ const raw = Uint8Array.from(atob(base64), c=>c.charCodeAt(0)); cryptoKey = await crypto.subtle.importKey("raw", raw, "AES-GCM", true, ["encrypt","decrypt"]); }
async function encryptMsg(msg){ const enc = new TextEncoder().encode(msg); const iv = crypto.getRandomValues(new Uint8Array(12)); const ciphertext = await crypto.subtle.encrypt({name:"AES-GCM", iv}, cryptoKey, enc); return {iv:Array.from(iv), data:Array.from(new Uint8Array(ciphertext))}; }
async function decryptMsg(payload){ const iv = new Uint8Array(payload.iv); const data = new Uint8Array(payload.data); const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, cryptoKey, data); return new TextDecoder().decode(plain); }

// --- Connection functions ---
function copyPeerId(){ navigator.clipboard.writeText(document.getElementById('myPeerId').innerText).then(()=>alert('Peer ID copied!')); }
function setStatus(text, cls){ const s=document.getElementById('status'); s.innerText="Status: "+text; s.className=cls; }
function addMsg(text,type){ const chat=document.getElementById('chat'); const div=document.createElement('div'); div.className = type==='me'?'message me':type==='friend'?'message friend':'message system'; div.innerHTML=text+`<div class="timestamp">${new Date().toLocaleTimeString()}</div>`; chat.appendChild(div); chat.scrollTop=chat.scrollHeight; }

function connectPeer(){
  const peerId=document.getElementById('peerIdInput').value.trim();
  if(!peerId) return alert('Enter Peer ID!');
  setStatus('Connecting...','connecting');
  conn = peer.connect(peerId);
  conn.on('open', async ()=>{
    setStatus('Connected to '+peerId,'connected');
    addMsg('‚úÖ Connected to '+peerId,'system');
    document.getElementById('sendBtn').disabled=false;
    document.getElementById('msgInput').disabled=false;
    conn.send({key:await exportKey()});
  });
  conn.on('data', handleData);
  conn.on('close', ()=>{ setStatus('Disconnected','disconnected'); addMsg('‚ùå Connection closed','system'); document.getElementById('sendBtn').disabled=true; document.getElementById('msgInput').disabled=true; });
  conn.on('error', ()=>{ setStatus('Error / Retry','disconnected'); addMsg('‚ö† Connection error. Try again.','system'); });
}

async function handleData(data){
  if(data.key){ await importKey(data.key); addMsg('üîê Secure channel established!','system'); }
  else if(data.msg){ const text=await decryptMsg(data.msg); addMsg(text,'friend'); }
}

async function sendMsg(){ const msg=document.getElementById('msgInput').value.trim(); if(conn && msg){ const encrypted=await encryptMsg(msg); conn.send({msg:encrypted}); addMsg(msg,'me'); document.getElementById('msgInput').value=''; } }

peer.on('connection', c=>{ conn=c; conn.on('data', handleData); setStatus('Connected to '+conn.peer,'connected'); addMsg('üîî Someone connected to you!','system'); document.getElementById('sendBtn').disabled=false; document.getElementById('msgInput').disabled=false; });
</script>
</body>
</html>
